---
author:
  - name: Sahir Bhatnagar *
    affiliation: McGill Univeristy
    address: >
      1020 Pine Avenue West
      Montreal, QC, Canada H3A 1A2
    email: \email{sahir.bhatnagar@mail.mcgill.ca}
    url: http://sahirbhatnagar.com/
  - name: Maxime Turgeon *
    affiliation: McGill University
    address: >
      1020 Pine Avenue West
      Montreal, QC, Canada H3A 1A2
    email: \email{maxime.turgeon@mail.mcgill.ca}
    url: http://maxturgeon.ca/
  - name: James Hanley
    affiliation: McGill Univeristy
    address: >
      1020 Pine Avenue West
      Montreal, QC, Canada H3A 1A2
    email: \email{james.hanley@mcgill.ca}
    url: http://www.medicine.mcgill.ca/epidemiology/hanley/
  - name: Olli Saarela
    affiliation: University of Toronto
    address: >
      Dalla Lana School of Public Health, 
      155 College Street, 6th floor, 
      Toronto, Ontario 
      M5T 3M7, Canada
    email: \email{olli.saarela@utoronto.ca}
    url: http://individual.utoronto.ca/osaarela/
title:
  formatted: "\\pkg{casebase}: An Alternative Framework For Survival Analysis"
  # If you use tex in the formatted title, also supply version without
  plain:     "casebase: An Alternative Framework For Survival Analysis"
  # For running headers, if needed
  short:     "\\pkg{casebase}: An Alternative Framework For Survival Analysis"
abstract: >
  The abstract of the article. * joint co-authors
keywords:
  # at least one keyword must be supplied
  formatted: [keywords, not capitalized, "\\proglang{Java}"]
  plain:     [keywords, not capitalized, Java]
bibliography: casebase_references.bib
csl: jss.csl
preamble: >
  \usepackage{amsmath}
output: rticles::jss_article
---

# Code formatting

Don't use markdown, instead use the more precise latex commands:

* \proglang{Java}
* \pkg{plyr}
* \code{print("abc")}



# Introduction

  - Motivation
    + Flexible 
    + Flexible
    + Flexible

# Theoretical details

# Implementation details

  1. Population-tim plots
  2. Sampling
  3. Fitting
  4. Absolute Risks

# Population-time plots

# Case study 1: Veteran data (or ERSPC if we can)

  - First example
  - Show how we can test for non-proportional hazard?

# Case study 2: Bone-marrow transplant

We will use the same data that was used in Scrucca *et al* [@scrucca2010regression]. The data is available on the main author's [website](http://www.stat.unipg.it/luca/R/); it is also available as part of this package.

```{r}
library(casebase)
library(magrittr)
library(tidyverse)
data(bmtcrr)
head(bmtcrr) %>% knitr::kable(format = "latex")
```

We will perform a competing risk analysis on data from 177 patients who received a stem cell transplant for acute leukemia. The event of interest in relapse, but other competing causes (e.g. transplant-related death) need to be taken into account. We also want to take into account the effect of several covariates such as Sex, Disease (lymphoblastic or myeloblastic leukemia, abbreviated as ALL and AML, respectively), Phase at transplant (Relapse, CR1, CR2, CR3), Source of stem cells (bone marrow and peripheral blood, coded as BM+PB, or peripheral blood, coded as PB), and Age. Below, we reproduce their Table 1:

```{r}
table1 <- tibble::tribble(
    ~Variable, ~Description, ~`Statistical summary`,
    "Sex", "Sex", "M=Male (100)",
    "", "", "F=Female (77)",
    "D", "Disease", "ALL (73)",
    "", "", "AML (104)",
    "Phase", "Phase", "CR1 (47)", 
    "", "", "CR2 (45)", 
    "", "", "CR3 (12)", 
    "", "", "Relapse (73)",
    "Source", "Type of transplant", "BM+PB (21)", 
    "", "", "PB (156)",
    "Age", "Age of patient (years)", "4–62", 
    "", "", "30.47 (13.04)",
    "Ftime", "Failure time (months)", "0.13–131.77",
    "", "", "20.28 (30.78)",
    "Status", "Status indicator", "0=censored (46)", 
    "", "", "1=relapse (56)", 
    "", "", "2=competing event (75)"
)

knitr::kable(table1, format = "latex")
```

<!-- | Variable | Description            | Statistical summary    | -->
<!-- | -------- | ---------------------- | ---------------------- | -->
<!-- | Sex      | Sex                    | M=Male (100) <br> F=Female (77) | -->
<!-- | D        | Disease                | ALL (73) <br> AML (104) | -->
<!-- | Phase    | Phase                  | CR1 (47) <br> CR2 (45) <br> CR3 (12) <br> Relapse (73) | -->
<!-- | Source   | Type of transplant     | BM+PB (21) <br> PB (156) | -->
<!-- | Age      | Age of patient (years) | 4–62 <br> 30.47 (13.04) | -->
<!-- | Ftime    | Failure time (months)  | 0.13–131.77 <br> 20.28 (30.78) | -->
<!-- | Status   | Status indicator       | 0=censored (46) <br> 1=relapse (56) <br> 2=competing event (75) | -->

The statistical summary is generated differently for continuous and categorical variables: 

 - For continuous variables, we are given the range, followed by the mean and standard deviation.
 
 - For categorical variables, we are given the counts for each category.
 
Note that failure time can also correspond to censoring.

In order to try and visualize the incidence density of relapse, we can look at a population-time plot: on the X-axis we have time, and on the Y-axis we have the size of the risk set at a particular time point. Failure times associated to the event of interest can then be highlighted on the plot using red dots.

```{r}
pt_object <- casebase::popTime(bmtcrr, event = "Status", time = "ftime")
plot(pt_object)
```

```{r}
pt_object_comp <- bmtcrr %>% 
    mutate(Status = case_when(Status == 1 ~ 2L, 
                              Status == 2 ~ 1L, 
                              TRUE ~ Status)) %>% 
    casebase::popTime(event = "Status", time = "ftime")
plot(pt_object_comp, point.colour = "blue")
```

From this last plot, we can see that there is no censoring during the first 10 months. Moreover, we see that the last competing event occurs around 20 months. Putting all this information together, we have evidence of two types of patients: very sick patients who either relapse or have a competing event early on, and healthier patients who are eventually lost to follow-up.

We now turn to the analysis of this dataset. The population-time plots above give evidence of non-constant hazard; therefore, we will explicitely include time in the model. Note that we also include all other variables as possible confounders. First, we include time as a linear term:

```{r warning=FALSE}
model1 <- fitSmoothHazard(Status ~ ftime + Sex + D + Phase + Source + Age, 
                          data = bmtcrr, 
                          ratio = 100,
                          time = "ftime")
summary(model1)
```

Because of the results in Turgeon *et al* [@turgeonCompRisk], the standard errors we obtain from the multinomial logit fit are asymptotically correct, and therefore can be used to construct asymptotic confidence intervals. 

From this summary, we see that time is indeed significant, as is Phase (only relapse vs. CR1). Interestingly, we see that the type of disease is only significant for the event of interest, whereas the type of transplant and the age of the patient are only significant for the competing event.

Next, we include the logarithm of time in the model (which leads to a Weibull hazard):


```{r warning = FALSE}
model2 <- fitSmoothHazard(Status ~ log(ftime) + Sex + D + Phase + Source + Age, 
                          data = bmtcrr, 
                          ratio = 100, 
                          time = "ftime")
summary(model2)
```

As we can see, the results are similar to the ones with a Gompertz hazard, although Sex is now significant for the competing event.

Finally, using splines, we can be quite flexible about the way the hazard depends on time:

```{r warning = FALSE}
model3 <- fitSmoothHazard(
    Status ~ splines::bs(ftime) + Sex + D + Phase + Source + Age, 
    data = bmtcrr, 
    ratio = 100, 
    time = "ftime")
summary(model3)
```

Again, we see that the results are quite similar for this third model.

We now look at the 2-year risk of relapse:

```{r absRisk, warning = FALSE}
linearRisk <- absoluteRisk(object = model1, time = 24, newdata = bmtcrr[1:10,])
logRisk <- absoluteRisk(object = model2, time = 24, newdata = bmtcrr[1:10,])
splineRisk <- absoluteRisk(object = model3, time = 24, newdata = bmtcrr[1:10,])
```

```{r absRiskPlot}
plot(linearRisk, logRisk,
     xlab = "Linear", ylab = "Log/Spline", pch = 19,
     xlim = c(0,1), ylim = c(0,1), col = 'red')
points(linearRisk, splineRisk,
       col = 'blue', pch = 19)
abline(a = 0, b = 1, lty = 2, lwd = 2)
legend("topleft", legend = c("Log", "Spline"),
       pch = 19, col = c("red", "blue"))
```

We can also estimate the mean absolute risk for the entire dataset:
```{r}
mean(linearRisk)
mean(logRisk)
mean(splineRisk)
```

```{r warning = FALSE, cache = TRUE}
# Absolute risks----
library(tidyverse)
library(magrittr)
library(splines)
library(survival)
library(timereg)

bmtcrr %<>% filter(Age >= 16)

bmtcrr %>% select(Sex) %>% table
bmtcrr %>% select(D) %>% table
bmtcrr %>% select(Phase) %>% table
bmtcrr %>% select(Source) %>% table
bmtcrr %>% select(Status) %>% table

model_cb <- fitSmoothHazard(Status ~ bs(ftime, df = 5) + Sex + D + Phase + Source + Age,
                            data = bmtcrr, time = "ftime")
model_fg <- comp.risk(Event(ftime, Status) ~ const(Sex) + const(D) + 
                          const(Phase) + const(Source) + const(Age), 
                      data = bmtcrr, cause = 1, model = "fg")
model_cox <- coxph(Surv(ftime, Status == 1) ~ Sex + D + Phase + Source + Age,
                   data = bmtcrr)

time_points <- (0:100)*60/100

# ALL vs. AML
newdata <- data.frame("Sex" = factor(c("F", "F"), 
                                     levels = c("F", "M")),
                      "D" = c("ALL", "AML"),
                      "Phase" = factor(c("Relapse", "Relapse"), 
                                       levels = c("CR1", "CR2", "CR3", "Relapse")),
                      "Age" = c(35, 35),
                      "Source" = factor(c("PB", "PB"), 
                                        levels = c("BM+PB", "PB")))

risk_cb <- absoluteRisk(object = model_cb, time = time_points,
                        method = "montecarlo", newdata = newdata)
risk_cb <- bind_rows(data.frame(Time = time_points, Method = "Case-base", Risk = risk_cb[,2], Disease = "ALL",
                                stringsAsFactors = FALSE),
                     data.frame(Time = time_points, Method = "Case-base", Risk = risk_cb[,3], Disease = "AML",
                                stringsAsFactors = FALSE))

risk_fg <- predict(model_fg, newdata, times = time_points)
risk_fg <- bind_rows(data.frame(Time = time_points, Method = "Fine-Gray", Risk = risk_fg$P1[1,], Disease = "ALL",
                                stringsAsFactors = FALSE),
                     data.frame(Time = time_points, Method = "Fine-Gray", Risk = risk_fg$P1[2,], Disease = "AML",
                                stringsAsFactors = FALSE))
risk_km <- map_df(c("ALL", "AML"), function(disease) {
    foo <- bmtcrr %>% 
        filter(D == disease) %>% 
        survfit(Surv(ftime,Status == 1) ~ 1, data = .)
    data.frame(Time = foo$time, Method = "Kaplan-Meier", Risk = 1 - foo$surv, Disease = disease,
               stringsAsFactors = FALSE) %>%
        filter(Time <= 60)
})

disease_names <- c("ALL" = "Acute Lymphoid Leukemia",
                   "AML" = "Acute Myeloid Leukemia")
risk_cb %>%
    bind_rows(risk_fg,
              risk_km) %>% 
    arrange(Disease, Risk) %>% 
    ggplot(aes(Time, Risk, colour = Method)) + 
    geom_line(data = . %>% filter(Method == "Case-base")) + 
    geom_step(data = . %>% filter(Method != "Case-base")) + 
    facet_grid(Disease ~ ., labeller = as_labeller(disease_names)) + ylim(c(0,1)) +
    theme(legend.position = "top") +
    xlab("Time (in Months)") + ylab("Relapse risk")
```

```{r}
# Table of coefficients----
z_value <- qnorm(0.975)
table_cb <- summary(model_cb)@coef3[seq(13, 25, by = 2), 1:2]
table_cb <- cbind(table_cb[,1], 
                  table_cb[,1] - z_value * table_cb[,2],
                  table_cb[,1] + z_value * table_cb[,2])
table_cb <- round(exp(table_cb), 2)

table_cox <- round(summary(model_cox)$conf.int[,-2], 2)
```


# Case study 3: Vaccination study (recurrent events)

  - Give a more complex example of sampling; time-dependent exposure
    + Sampling needs to be done manually, but fitting function can still be used 

# Discussion

# References {-}
<!-- placeholder for References in toc --!>







